---
title: 监控系统
description: 基于 Rollbar 的前后端错误追踪与上下文记录
---

import { Callout } from 'fumadocs-ui/components/callout'

# 监控系统

基于 Rollbar 的完整错误监控方案，覆盖浏览器与服务端，并提供 React 集成与上下文追踪。

<Callout type="info">
系统会自动捕获未处理错误，并提供手动上报与上下文设置能力。
</Callout>

> 前端 hook 位于 `src/hooks/use-monitoring.ts`，浏览器/服务端的 SDK 封装在 `src/components/monitoring/` 目录。

## 核心特性

### 自动捕获 (＾▽＾)
- 未捕获的 JS 异常
- 未处理的 Promise 拒绝
- React 组件错误
- 服务端异常

### 手动上报 (・ω・)
```ts
const { captureError, captureMessage } = useMonitoring()
captureError(new Error('Something went wrong'), { user_action: 'form_submit' })
captureMessage('User performed action', 'info', { action: 'button_click' })
```

### 用户上下文 (￣▽￣)
```ts
const { setUser } = useMonitoring()
setUser({ id: 'user_123', email: 'user@example.com', username: 'johndoe' })
```

### 自定义上下文 (・∀・)
```ts
const { setContext } = useMonitoring()
setContext('current_page', '/dashboard')
setContext('feature_flags', { newUI: true })
```

## 配置与使用

<div className="fd-steps">
  <div className="fd-step">
    ### 1）添加环境变量
    在 `.env` / Vercel 环境变量中添加：
    ```bash
    NEXT_PUBLIC_ROLLBAR_ACCESS_TOKEN=your_client_token
    ROLLBAR_SERVER_ACCESS_TOKEN=your_server_token
    ```
    <Callout type="warning">客户端与服务端需要不同 Token。</Callout>
  </div>
  <div className="fd-step">
    ### 2）挂载前端监控
    在根布局附近渲染一次 `<Monitoring />`（内部导出 RollbarAnalytics）。
  </div>
  <div className="fd-step">
    ### 3）在应用中使用 hook
    从 `@/hooks/use-monitoring` 引入，用于上报错误/消息、设置用户与上下文。
  </div>
  <div className="fd-step">
    ### 4）服务端工具
    在 API/Route Handler 中使用 `@/components/monitoring/rollbar-server-monitoring` 的 `serverCaptureError/serverCaptureMessage`。
  </div>
  <div className="fd-step">
    ### 5）验证
    主动触发一条测试错误，确认在 Rollbar 面板可见。
  </div>
</div>

## 日志等级与示例

```ts
const events = useMonitoringEvents()
events.critical('Database connection failed', { database: 'primary' })
events.error('Payment processing failed', { payment_id: 'pay_123' })
events.warn('API rate limit approaching', { current_usage: 950, limit: 1000 })
events.info('User feature usage', { feature: 'advanced_search' })
events.debug('Component render details', { component: 'UserProfile' })
```

## 错误边界集成

```tsx
export class ErrorBoundary extends Component<Props, State> {
  componentDidCatch(error: Error, errorInfo: any) {
    captureError(error, { error_boundary: 'GlobalErrorBoundary', component_stack: errorInfo.componentStack })
  }
}
```

## 最佳实践

- 在关键路径设置用户与上下文，提升排障效率。
- 服务端注意脱敏请求头与敏感数据。
- 结合分析系统记录关键操作事件，形成闭环。

## 常见问题 Q&A

**Q: 客户端没上报但控制台没有错误？**  
**A:** 请确认 `NEXT_PUBLIC_ROLLBAR_ACCESS_TOKEN` 是否配置；浏览器端仅在有 Token 时初始化。还要检查网络拦截器/广告屏蔽是否阻断请求 (＾_＾)。

**Q: 服务端如何保证不泄露敏感信息？**  
**A:** 上报前对请求头和请求体做脱敏；仅保留必要字段。可以在 `serverCaptureError` 的 `context` 中传入已脱敏的数据 (・ω・)。

**Q: 如何区分用户或会话？**  
**A:** 登录成功后调用 `setUser({ id, email, username })` 进行标识。登出时可清空或重置用户上下文，避免串线 (￣ー￣)。

**Q: React 组件报错如何统一处理？**  
**A:** 使用错误边界组件包裹根布局或关键区域，在 `componentDidCatch` 中调用 `captureError`，并提供组件栈信息，便于问题定位 (＾▽＾)。

